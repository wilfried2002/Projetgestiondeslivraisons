<!-- templates/livraison/feuille_detail.html -->
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Feuille de route</title>
  <style>
    .badge{padding:2px 6px;border-radius:4px}
    .green{background:#c8f7c5}.orange{background:#ffe6a7}.red{background:#f8c5c5}
    .produits-sacs{background:#f8f9fa;padding:8px;border-radius:4px;margin:8px 0}
    .tag{display:inline-block;background:#007bff;color:white;padding:2px 6px;border-radius:12px;font-size:12px;margin:2px}
    body{font-family:Arial,sans-serif;margin:20px;background:#f5f5f5}
    .container{max-width:800px;margin:0 auto;background:white;padding:20px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
    .header{background:#007bff;color:white;padding:15px;border-radius:8px;margin-bottom:20px}
    .livraison-item{border:1px solid #ddd;border-radius:8px;padding:15px;margin-bottom:15px}
    .btn{background:#007bff;color:white;border:none;padding:8px 16px;border-radius:4px;cursor:pointer}
    .btn:hover{background:#0056b3}
    .btn-success{background:#28a745}
    .btn-warning{background:#ffc107;color:#212529}
    .btn-danger{background:#dc3545}
    .form-group{margin-bottom:10px}
    .form-group label{display:block;margin-bottom:5px;font-weight:bold}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px}
    .status-badge{display:inline-block;padding:4px 8px;border-radius:12px;font-size:12px;font-weight:bold}
    
    /* Styles pour la signature tactile */
    .signature-pad {
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
      cursor: crosshair;
      margin: 10px 0;
    }
    .signature-controls {
      margin: 10px 0;
    }
    .signature-controls button {
      margin-right: 10px;
      padding: 5px 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #f8f9fa;
      cursor: pointer;
    }
    .signature-controls button:hover {
      background: #e9ecef;
    }
    
    /* Styles pour les observations */
    .observations-section {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .observations-display {
      background: white;
      padding: 10px;
      border-radius: 4px;
      border-left: 4px solid #007bff;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h2>Feuille de route #{{ feuille.id }}</h2>
      <p><strong>Chauffeur:</strong> {{ feuille.chauffeur.user.get_full_name|default:feuille.chauffeur.user.username }}</p>
      {% if feuille.vehicule %}
        <p><strong>V√©hicule:</strong> {{ feuille.vehicule.marque }} {{ feuille.vehicule.modele }} ‚Äî <strong>Immat:</strong> {{ feuille.vehicule.immatriculation }}</p>
      {% else %}
        <p><strong>V√©hicule:</strong> <em>Aucun v√©hicule assign√©</em></p>
      {% endif %}
      <p><strong>Date:</strong> {{ feuille.date_route|default:feuille.date_creation }}</p>
      <p><strong>Statut:</strong> 
        <span class="status-badge {% if feuille.statut == 'terminee' %}green{% elif feuille.statut == 'probleme' %}red{% else %}orange{% endif %}">
          {{ feuille.get_statut_display }}
        </span>
      </p>
    </div>

    <!-- Section Observations -->
    <div class="observations-section">
      <h3>üìù Observations du chauffeur</h3>
      {% if feuille.observations_chauffeur %}
        <div class="observations-display">
          <p><strong>Observations:</strong></p>
          <p>{{ feuille.observations_chauffeur|linebreaks }}</p>
          {% if feuille.date_observations %}
            <small><em>Ajout√© le {{ feuille.date_observations|date:"d/m/Y √† H:i" }}</em></small>
          {% endif %}
        </div>
      {% else %}
        <p><em>Aucune observation pour le moment</em></p>
      {% endif %}
      
      <form method="post" style="margin-top: 15px;">
        {% csrf_token %}
        <div class="form-group">
          <label for="observations_chauffeur">Ajouter/modifier les observations:</label>
          <textarea name="observations_chauffeur" id="observations_chauffeur" rows="4" placeholder="D√©crivez ici vos observations, probl√®mes rencontr√©s, etc...">{{ feuille.observations_chauffeur }}</textarea>
        </div>
        <button type="submit" name="update_observations" class="btn btn-success">üíæ Sauvegarder les observations</button>
      </form>
    </div>

    {% if feuille.qr_code %}
      <div style="text-align:center;margin-bottom:20px;">
        <p><strong>QR Code de la feuille:</strong></p>
        <img src="{{ feuille.qr_code.url }}" alt="QR" width="150" style="border:2px solid #ddd;border-radius:8px;">
      </div>
    {% endif %}

    {% if feuille.statut == 'planifie' %}
      <form method="post" style="margin-bottom:20px;">
        {% csrf_token %}
        <button type="submit" name="start_route" class="btn btn-success"> Marquer "En route"</button>
      </form>
    {% endif %}

    <h3> Livraisons ({{ livraisons|length }})</h3>
    
    {% for l in livraisons %}
      <div class="livraison-item">
        <div style="margin-bottom:15px;">
          <h4>{{ l.client.nom }} ‚Äî {{ l.client.telephone }}</h4>
          <p><strong>Adresse:</strong> {{ l.client.adresse }}</p>
          <p><strong>R√©f√©rence:</strong> {{ l.reference_commande }} ‚Äî <strong>Quantit√©:</strong> {{ l.quantite }}</p>
          {% if l.horaire_estime %}
            <p><strong>Horaire estim√©:</strong> {{ l.horaire_estime }}</p>
          {% endif %}
          <p><strong>Statut:</strong> 
            <span class="status-badge {% if l.statut == 'livre' %}green{% elif l.statut == 'probleme' %}red{% else %}orange{% endif %}">
              {{ l.get_statut_display }}
            </span>
          </p>
        </div>

        {% if l.produits.all or l.sacs.all %}
          <div class="produits-sacs">
            {% if l.produits.all %}
              <p><strong>Produits:</strong></p>
              {% for produit in l.produits.all %}
                <span class="tag">{{ produit.nom }} ({{ produit.prix_unitaire }} FCFA)</span>
              {% endfor %}
            {% endif %}
            {% if l.sacs.all %}
              <p><strong>Sacs:</strong></p>
              {% for sac in l.sacs.all %}
                <span class="tag">{{ sac.nom }} - {{ sac.couleur }}</span>
              {% endfor %}
            {% endif %}
          </div>
        {% endif %}

        <form action="{% url 'livraison:update_livraison_status' l.id %}" method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="form-group">
            <label>Changer le statut:</label>
            <select name="statut" class="form-control">
              <option value="en_cours" {% if l.statut == 'en_cours' %}selected{% endif %}>En cours</option>
              <option value="livre" {% if l.statut == 'livre' %}selected{% endif %}>Livr√©</option>
              <option value="probleme" {% if l.statut == 'probleme' %}selected{% endif %}>Probl√®me</option>
            </select>
          </div>
          
          <div class="form-group">
            <label>Preuve photo (optionnel):</label>
            <input type="file" name="preuve_photo" accept="image/*" capture="environment">
          </div>
          
          <div class="form-group">
            <label>Signature client - Fichier (optionnel):</label>
            <input type="file" name="signature_client" accept="image/*">
          </div>
          
          <!-- Signature tactile -->
          <div class="form-group">
            <label>Signature tactile (optionnel):</label>
            <div class="signature-controls">
              <button type="button" onclick="clearSignature('{{ l.id }}')">üñçÔ∏è Effacer</button>
              <button type="button" onclick="saveSignature('{{ l.id }}')">üíæ Sauvegarder</button>
            </div>
            <canvas id="signature-pad-{{ l.id }}" class="signature-pad" width="400" height="200"></canvas>
            <input type="hidden" name="signature_tactile" id="signature-data-{{ l.id }}" value="">
          </div>
          
          <button type="submit" class="btn">üíæ Mettre √† jour</button>
        </form>

        {% if l.preuve_photo %}
          <div style="margin-top:10px;">
            <p><strong> Photo de preuve:</strong></p>
            <img src="{{ l.preuve_photo.url }}" alt="" width="200" style="border-radius:8px;">
          </div>
        {% endif %}
        
        {% if l.signature_client %}
          <div style="margin-top:10px;">
            <p><strong>‚úçÔ∏è Signature client (fichier):</strong></p>
            <img src="{{ l.signature_client.url }}" alt="" width="200" style="border-radius:8px;">
          </div>
        {% endif %}
        
        {% if l.signature_tactile %}
          <div style="margin-top:10px;">
            <p><strong>‚úçÔ∏è Signature tactile:</strong></p>
            <div id="signature-display-{{ l.id }}"></div>
          </div>
        {% endif %}
        
        {% if l.date_livraison %}
          <div style="margin-top:10px;color:#28a745;">
            <strong>‚úÖ Livr√© le {{ l.date_livraison|date:"d/m/Y √† H:i" }}</strong>
          </div>
        {% endif %}
        
        <div style="margin-top:10px;font-size:12px;color:#666;">
          <strong>Lien de suivi client:</strong> 
          <a href="{{ l.get_public_url }}" target="_blank">{{ request.scheme }}://{{ request.get_host }}{{ l.get_public_url }}</a>
        </div>
      </div>
    {% empty %}
      <div style="text-align:center;padding:40px;color:#666;">
        <h3> Aucune livraison</h3>
        <p>Cette feuille de route ne contient aucune livraison.</p>
      </div>
    {% endfor %}
  </div>


  <script>
    // Signature tactile
    const signaturePads = {};
    
    {% for l in livraisons %}
      const canvas{{ l.id }} = document.getElementById('signature-pad-{{ l.id }}');
      const ctx{{ l.id }} = canvas{{ l.id }}.getContext('2d');
      let isDrawing{{ l.id }} = false;
      let lastX{{ l.id }} = 0;
      let lastY{{ l.id }} = 0;
      
      // Configuration du canvas
      ctx{{ l.id }}.strokeStyle = '#000';
      ctx{{ l.id }}.lineWidth = 2;
      ctx{{ l.id }}.lineCap = 'round';
      
      // √âv√©nements de dessin
      canvas{{ l.id }}.addEventListener('mousedown', startDrawing{{ l.id }});
      canvas{{ l.id }}.addEventListener('mousemove', draw{{ l.id }});
      canvas{{ l.id }}.addEventListener('mouseup', stopDrawing{{ l.id }});
      canvas{{ l.id }}.addEventListener('mouseout', stopDrawing{{ l.id }});
      
      // Support tactile
      canvas{{ l.id }}.addEventListener('touchstart', handleTouchStart{{ l.id }});
      canvas{{ l.id }}.addEventListener('touchmove', handleTouchMove{{ l.id }});
      canvas{{ l.id }}.addEventListener('touchend', stopDrawing{{ l.id }});
      
      function startDrawing{{ l.id }}(e) {
        isDrawing{{ l.id }} = true;
        const rect = canvas{{ l.id }}.getBoundingClientRect();
        lastX{{ l.id }} = e.clientX - rect.left;
        lastY{{ l.id }} = e.clientY - rect.top;
      }
      
      function draw{{ l.id }}(e) {
        if (!isDrawing{{ l.id }}) return;
        e.preventDefault();
        
        const rect = canvas{{ l.id }}.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        ctx{{ l.id }}.beginPath();
        ctx{{ l.id }}.moveTo(lastX{{ l.id }}, lastY{{ l.id }});
        ctx{{ l.id }}.lineTo(x, y);
        ctx{{ l.id }}.stroke();
        
        lastX{{ l.id }} = x;
        lastY{{ l.id }} = y;
      }
      
      function stopDrawing{{ l.id }}() {
        isDrawing{{ l.id }} = false;
      }
      
      function handleTouchStart{{ l.id }}(e) {
        e.preventDefault();
        const touch = e.touches[0];
        const rect = canvas{{ l.id }}.getBoundingClientRect();
        lastX{{ l.id }} = touch.clientX - rect.left;
        lastY{{ l.id }} = touch.clientY - rect.top;
        isDrawing{{ l.id }} = true;
      }
      
      function handleTouchMove{{ l.id }}(e) {
        e.preventDefault();
        if (!isDrawing{{ l.id }}) return;
        
        const touch = e.touches[0];
        const rect = canvas{{ l.id }}.getBoundingClientRect();
        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;
        
        ctx{{ l.id }}.beginPath();
        ctx{{ l.id }}.moveTo(lastX{{ l.id }}, lastY{{ l.id }});
        ctx{{ l.id }}.lineTo(x, y);
        ctx{{ l.id }}.stroke();
        
        lastX{{ l.id }} = x;
        lastY{{ l.id }} = y;
      }
      
      // Fonctions globales
      window.clearSignature{{ l.id }} = function() {
        ctx{{ l.id }}.clearRect(0, 0, canvas{{ l.id }}.width, canvas{{ l.id }}.height);
        document.getElementById('signature-data-{{ l.id }}').value = '';
      };
      
      window.saveSignature{{ l.id }} = function() {
        const dataURL = canvas{{ l.id }}.toDataURL();
        document.getElementById('signature-data-{{ l.id }}').value = dataURL;
      };
      
      // Afficher la signature existante si elle existe
      {% if l.signature_tactile %}
        const displayDiv{{ l.id }} = document.getElementById('signature-display-{{ l.id }}');
        const img{{ l.id }} = document.createElement('img');
        img{{ l.id }}.src = '{{ l.signature_tactile }}';
        img{{ l.id }}.style.width = '200px';
        img{{ l.id }}.style.borderRadius = '8px';
        displayDiv{{ l.id }}.appendChild(img{{ l.id }});
      {% endif %}
    {% endfor %}
    
    // Fonctions globales pour tous les pads
    function clearSignature(padId) {
      const canvas = document.getElementById('signature-pad-' + padId);
      if (canvas) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        document.getElementById('signature-data-' + padId).value = '';
      }
    }
    
    function saveSignature(padId) {
      const canvas = document.getElementById('signature-pad-' + padId);
      if (canvas) {
        const dataURL = canvas.toDataURL();
        document.getElementById('signature-data-' + padId).value = dataURL;
      }
    }
    
    // G√©olocalisation automatique
    if (navigator.geolocation) {
      setInterval(() => {
        navigator.geolocation.getCurrentPosition(pos => {
          const formData = new FormData();
          formData.append('lat', pos.coords.latitude);
          formData.append('lng', pos.coords.longitude);
          fetch(window.location.pathname + 'position/', { 
            method: 'POST', 
            body: formData, 
            headers: {'X-CSRFToken': '{{ csrf_token }}'}
          }).catch(()=>{});
        });
      }, 60000); // Toutes les minutes
    }
  </script>
</body>
</html>